{% comment %}
	All Products Section with AJAX "Load More" (fixed)
{% endcomment %}

<section
	id="AllProductsSection-{{ section.id }}"
	class="all-products-section"
	data-section-id="{{ section.id }}"
	data-products-per-row="{{ section.settings.products_per_row }}"
	data-products-limit="{{ section.settings.products_limit }}"
	{% if section.settings.collection != blank %}
		{% assign collection = collections[section.settings.collection] %}
		data-collection-handle="{{ section.settings.collection }}"
		data-collection-total="{{ collection.products_count }}"
	{% endif %}
>
	<div class="page-width">
		{% if section.settings.collection != blank %}
			{% assign collection = collections[section.settings.collection] %}
			{% if collection.products_count > 0 %}
				<div
					id="ProductGrid-{{ section.id }}"
					class="grid grid--{{ section.settings.products_per_row }}-col"
				>
					{% paginate collection.products by section.settings.products_limit %}
						{% for product in collection.products %}
							<div class="grid__item">
								{% render 'product-card', product: product %}
							</div>
						{% endfor %}
					{% endpaginate %}
				</div>

				{% if collection.products_count > section.settings.products_limit %}
					<div class="load-more-wrapper">
						<button
							id="LoadMoreBtn-{{ section.id }}"
							class="load-more-btn"
							data-page="2"
						>
							Load More
						</button>
					</div>
				{% endif %}
			{% else %}
				<p>No products found in this collection.</p>
			{% endif %}
		{% else %}
			<p>Please select a collection in the section settings.</p>
		{% endif %}
	</div>
</section>

<style>
	.grid {
		display: grid;
		gap: 1.5rem;
	}
	.grid--1-col {
		grid-template-columns: repeat(1, 1fr);
	}
	.grid--2-col {
		grid-template-columns: repeat(2, 1fr);
	}
	.grid--3-col {
		grid-template-columns: repeat(3, 1fr);
	}
	.grid--4-col {
		grid-template-columns: repeat(4, 1fr);
	}
	.grid--5-col {
		grid-template-columns: repeat(5, 1fr);
	}

	.load-more-wrapper {
		text-align: center;
		margin-top: 2rem;
	}
	.load-more-btn {
		background: #000;
		color: #fff;
		padding: 0.75rem 1.5rem;
		border: none;
		border-radius: 4px;
		cursor: pointer;
	}
	.load-more-btn[disabled] {
		opacity: 0.6;
		cursor: default;
	}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('[id^="AllProductsSection-"]').forEach((section) => {
    const btn = section.querySelector('.load-more-btn');
    if (!btn) return;

    const grid = section.querySelector('.grid');
    const limit = parseInt(section.dataset.productsLimit || '0', 10);
    const sectionId = section.dataset.sectionId;
    const total = parseInt(section.dataset.collectionTotal || '0', 10);
    const sectionName = 'all-products'; // must match filename

    btn.addEventListener('click', () => {
      const page = parseInt(btn.dataset.page || '2', 10);
      btn.textContent = 'Loading...';
      btn.disabled = true;

      const url = `${window.location.pathname}?sections=${sectionName}&page=${page}`;

      fetch(url)
        .then((res) => res.json())
        .then((data) => {
          const html = data[sectionName]?.html;
          if (!html) throw new Error('Invalid section response');

          // âœ… Clean out <script> tags before parsing
          const cleanHTML = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');

          const temp = document.createElement('div');
          temp.innerHTML = cleanHTML;

          const newItems = temp.querySelectorAll(`#AllProductsSection-${sectionId} .grid__item`);
          if (!newItems.length) throw new Error('No grid items found');

          newItems.forEach(item => grid.appendChild(item));

          const currentCount = grid.querySelectorAll('.grid__item').length;
          if (total && currentCount >= total) {
            btn.style.display = 'none';
          } else if (newItems.length < limit) {
            btn.style.display = 'none';
          } else {
            btn.dataset.page = page + 1;
            btn.textContent = 'Load More';
            btn.disabled = false;
          }
        })
        .catch((err) => {
          console.error('Load more failed:', err);
          btn.textContent = 'Load More';
          btn.disabled = false;
        });
    });
  });
});
</script>

{% schema %}
{
	"name": "All Products (Load More)",
	"settings": [
		{
			"type": "collection",
			"id": "collection",
			"label": "Select collection"
		},
		{
			"type": "range",
			"id": "products_per_row",
			"label": "Products per row",
			"min": 1,
			"max": 5,
			"step": 1,
			"default": 3
		},
		{
			"type": "range",
			"id": "products_limit",
			"label": "Products per page (load batch size)",
			"min": 3,
			"max": 24,
			"step": 3,
			"default": 9
		}
	],
	"presets": [
		{
			"name": "All Products Grid (Load More)",
			"category": "Products"
		}
	]
}
{% endschema %}
